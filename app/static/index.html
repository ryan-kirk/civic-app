<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CivicWatch Explorer</title>
  <style>
    :root {
      --bg: #f3efe6;
      --ink: #1f2421;
      --muted: #5e645f;
      --panel: #fffdf8;
      --accent: #0e7490;
      --accent-2: #155e75;
      --line: #d7d2c8;
      --ok: #0f766e;
      --warn: #b45309;
      --chip: #edf6f8;
    }
    [hidden] { display: none !important; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      color: var(--ink);
      overflow: hidden;
      background:
        radial-gradient(1000px 500px at 10% -10%, #dce8e9 0%, transparent 60%),
        radial-gradient(900px 450px at 90% -5%, #efe6d5 0%, transparent 60%),
        var(--bg);
    }
    .wrap {
      max-width: 1200px;
      height: 100vh;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr);
      gap: 12px;
    }
    .hero { margin-bottom: 18px; }
    .hero h1 { margin: 0; font-size: clamp(1.7rem, 4vw, 2.5rem); letter-spacing: .02em; }
    .hero p { margin: 8px 0 0; color: var(--muted); }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.04);
    }
    .workspace {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(300px, 1fr);
      gap: 16px;
      align-items: stretch;
      min-height: 0;
      height: 100%;
    }
    .main-col { min-width: 0; min-height: 0; height: 100%; overflow-y: auto; padding-right: 4px; }
    .side-col { min-width: 0; min-height: 0; height: 100%; overflow: hidden; }
    .sticky {
      position: sticky;
      top: 0;
      height: 100%;
      max-height: 100%;
      overflow: hidden;
    }

    form { display: grid; gap: 12px; }
    .grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(6, minmax(0, 1fr));
    }
    label { font-size: .85rem; color: var(--muted); display: block; margin-bottom: 4px; }
    input, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px 11px;
      font-size: 0.95rem;
      background: white;
    }
    .hint { margin-top: 4px; font-size: .78rem; color: var(--muted); }
    .col-2 { grid-column: span 2; }
    .col-1 { grid-column: span 1; }
    .checks { display: flex; gap: 18px; align-items: center; flex-wrap: wrap; }
    .checks label { margin: 0; color: var(--ink); font-size: .9rem; }
    .checks input { width: auto; margin-right: 6px; }

    button {
      appearance: none;
      border: 0;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      padding: 12px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform .12s ease, opacity .12s ease;
    }
    button:hover { transform: translateY(-1px); }
    button:disabled { opacity: .6; cursor: not-allowed; transform: none; }

    .status { margin-top: 10px; font-size: .92rem; color: var(--muted); min-height: 1.25rem; }

    .progress-wrap { margin-top: 8px; }
    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #e8e4db;
      border: 1px solid var(--line);
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width .2s ease;
    }

    .summary {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .kpi {
      background: #f8f6ef;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
    }
    .kpi .k { color: var(--muted); font-size: .8rem; }
    .kpi .v { font-weight: 700; font-size: 1.1rem; margin-top: 4px; }

    .related {
      margin-top: 12px;
      padding: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8f6ef;
      font-size: .85rem;
      color: var(--muted);
    }

    .results { margin-top: 18px; display: grid; gap: 12px; }
    .meeting {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 12px;
    }
    .meeting h3 { margin: 0 0 4px; font-size: 1rem; }
    .meta { font-size: .86rem; color: var(--muted); margin-bottom: 8px; }
    .meta-link { color: #0b4d5f; text-decoration: none; cursor: pointer; }
    .meta-link:hover { text-decoration: underline; }
    .item {
      padding: 8px;
      border: 1px solid #ece7dc;
      border-radius: 8px;
      margin-top: 6px;
      background: #fffcf5;
    }
    .topic-row { margin-top: 5px; display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      border: 1px solid #c9dbe0;
      border-radius: 999px;
      background: var(--chip);
      padding: 2px 8px;
      font-size: .75rem;
      color: #0b4d5f;
      cursor: pointer;
    }
    .chip.active { background: #c8e8f0; border-color: #7ec3d7; }
    .signals { font-size: .8rem; color: var(--warn); margin-top: 4px; }
    .doc-list { margin-top: 6px; display: grid; gap: 4px; }
    .doc-link {
      display: inline-block;
      font-size: .8rem;
      color: #0b4d5f;
      text-decoration: none;
      border-bottom: 1px dotted #9cc5d1;
      width: fit-content;
    }
    .doc-link:hover { text-decoration: underline; }
    .minutes {
      margin-top: 8px;
      border: 1px dashed #d7d2c8;
      border-radius: 8px;
      background: #f9f9f6;
      padding: 8px;
    }
    .minutes-title { font-size: .78rem; color: var(--muted); margin-bottom: 4px; }
    .minutes-row { font-size: .8rem; color: #2d3431; margin-top: 4px; }
    .minutes-row a { color: #0b4d5f; text-decoration: none; }
    .minutes-row a:hover { text-decoration: underline; }
    .entity-panel {
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fbfaf6;
      padding: 10px;
    }
    .startup-panel {
      margin-top: 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 10px;
    }
    .entity-title { font-size: .8rem; color: var(--muted); margin-bottom: 6px; }
    .entity-list { display: flex; flex-wrap: wrap; gap: 6px; }
    .entity-chip {
      border: 1px solid #d8dad1;
      background: #f4f6ee;
      color: #374133;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: .75rem;
      cursor: pointer;
    }
    .search-panel {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8f6ef;
      padding: 10px;
      display: grid;
      grid-template-rows: auto auto auto auto auto minmax(0, 1fr);
      gap: 8px;
      height: 100%;
      min-height: 0;
    }
    .sidebar-scroll {
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
    }
    .view-tabs { display: flex; gap: 6px; flex-wrap: wrap; }
    .tab-btn {
      border: 1px solid #c9dbe0;
      border-radius: 999px;
      background: #fff;
      color: #0b4d5f;
      padding: 4px 10px;
      font-size: .78rem;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #dceef3;
      border-color: #86c7d8;
      font-weight: 600;
    }
    .search-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .search-row input { flex: 1 1 240px; }
    .search-box { position: relative; }
    .suggestions {
      position: absolute;
      left: 0;
      right: 0;
      top: calc(100% + 4px);
      z-index: 30;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: white;
      box-shadow: 0 10px 25px rgba(0,0,0,.08);
      max-height: 220px;
      overflow-y: auto;
    }
    .suggestion-item {
      width: 100%;
      border: 0;
      border-bottom: 1px solid #eee8da;
      background: #fff;
      text-align: left;
      padding: 8px 10px;
      color: var(--ink);
      cursor: pointer;
      border-radius: 0;
    }
    .suggestion-item:last-child { border-bottom: 0; }
    .suggestion-item:hover { background: #f7fbfc; }
    .suggestion-meta { font-size: .74rem; color: var(--muted); margin-top: 2px; }
    .search-results { margin-top: 8px; display: grid; gap: 6px; }
    .search-subtitle { margin-top: 10px; font-size: .78rem; color: var(--muted); }
    .search-result {
      border: 1px solid #e2ddd2;
      background: #fff;
      border-radius: 8px;
      padding: 8px;
      font-size: .82rem;
    }
    .search-result button {
      background: transparent;
      color: #0b4d5f;
      border: 0;
      padding: 0;
      font: inherit;
      font-weight: 600;
      cursor: pointer;
      text-align: left;
    }
    .search-result button:hover { text-decoration: underline; }
    .runtime-panel {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      padding: 8px;
      font-size: .8rem;
      color: #3e4642;
      display: grid;
      gap: 2px;
      min-height: 0;
    }
    .runtime-panel .meta { margin: 0; overflow-wrap: anywhere; }
    .runtime-ok { color: #0f766e; }
    .runtime-warn { color: #b45309; }
    .map-link {
      display: inline-block;
      margin-top: 4px;
      font-size: .78rem;
      color: #0b4d5f;
      text-decoration: none;
    }
    .map-link:hover { text-decoration: underline; }
    .mention-list { margin-top: 6px; display: grid; gap: 5px; }
    .mention-line {
      border-top: 1px dashed #e6e0d4;
      padding-top: 5px;
      color: #525954;
    }
    .mention-line:first-child { border-top: 0; padding-top: 0; }
    .mention-meta {
      font-size: .72rem;
      color: var(--muted);
      margin-bottom: 2px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .mention-context {
      font-size: .78rem;
      color: #343a36;
      line-height: 1.35;
    }
    .context-hit {
      background: #fff2bf;
      border-radius: 3px;
      padding: 0 2px;
    }

    @media (max-width: 900px) {
      body { overflow: auto; }
      .wrap { height: auto; min-height: 100vh; display: block; padding: 24px 16px 48px; }
      .grid { grid-template-columns: 1fr 1fr; }
      .col-2, .col-1 { grid-column: span 1; }
      .summary { grid-template-columns: 1fr; }
      .workspace { grid-template-columns: 1fr; height: auto; }
      .main-col, .side-col { overflow: visible; }
      .sticky { position: static; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>CivicWatch Explorer</h1>
      <p>Ingest a meeting range, then filter agenda items by topic.</p>
    </section>

    <section class="workspace">
      <div class="main-col">
    <section class="panel">
      <form id="queryForm">
        <div class="grid">
          <div class="col-2">
            <label for="fromDate">From Date</label>
            <input id="fromDate" name="fromDate" type="date" required />
          </div>
          <div class="col-2">
            <label for="toDate">To Date</label>
            <input id="toDate" name="toDate" type="date" required />
          </div>
          <div class="col-1">
            <label for="limit">Limit</label>
            <input id="limit" name="limit" type="number" min="1" max="1000" value="100" />
          </div>
          <div class="col-1">
            <label for="chunkDays">Chunk Days</label>
            <input id="chunkDays" name="chunkDays" type="number" min="1" max="90" value="31" />
            <div class="hint">Days per CivicWeb crawl window. Smaller = more API calls, safer for long ranges.</div>
          </div>
          <div class="col-2">
            <label for="topic">Topic</label>
            <select id="topic" name="topic">
              <option value="">All Topics</option>
              <option value="zoning">zoning</option>
              <option value="ordinances_general">ordinances_general</option>
              <option value="public_hearings">public_hearings</option>
              <option value="contracts_procurement">contracts_procurement</option>
              <option value="budget_finance">budget_finance</option>
              <option value="infrastructure_transport">infrastructure_transport</option>
              <option value="urban_renewal_development">urban_renewal_development</option>
              <option value="boards_commissions">boards_commissions</option>
              <option value="licenses_permits">licenses_permits</option>
              <option value="utilities_franchise">utilities_franchise</option>
            </select>
          </div>
        </div>

        <div class="checks">
          <label><input id="crawl" type="checkbox" checked /> Crawl Historic Windows</label>
          <label><input id="storeRaw" type="checkbox" checked /> Store Raw Source Payloads</label>
        </div>

        <div>
          <button id="runBtn" type="submit">Run Ingest + Filter</button>
        </div>
      </form>

      <div id="status" class="status"></div>
      <div class="progress-wrap" id="progressWrap" hidden>
        <div class="progress-track"><div id="progressBar" class="progress-bar"></div></div>
      </div>

      <div id="summary" class="summary" hidden>
        <div class="kpi"><div class="k">Discovered</div><div class="v" id="kDiscovered">0</div></div>
        <div class="kpi"><div class="k">Ingested</div><div class="v" id="kIngested">0</div></div>
        <div class="kpi"><div class="k">Agenda Items Returned</div><div class="v" id="kItems">0</div></div>
      </div>
    </section>
        <div id="related" class="related" hidden></div>
        <section id="results" class="results"></section>
      </div>
      <aside class="side-col">
        <div class="search-panel sticky">
          <div class="entity-title">Explore Saved Entities</div>
          <div class="view-tabs">
            <button id="tabSearch" type="button" class="tab-btn active">Search</button>
            <button id="tabTimeline" type="button" class="tab-btn">Timeline</button>
            <button id="tabMap" type="button" class="tab-btn">Map</button>
          </div>
          <div class="search-row">
            <div class="search-box">
              <input id="entitySearch" type="search" placeholder="Search entities (person, org, address, ordinance, date)..." />
              <div id="entitySuggestions" class="suggestions" hidden></div>
            </div>
            <button id="entitySearchBtn" type="button">Search Entities</button>
          </div>
          <div class="hint">Entity search stays visible while you scroll agenda results. Click a result to load related entities.</div>
          <div id="runtimePanel" class="runtime-panel">Runtime diagnostics loading...</div>
          <div class="sidebar-scroll">
            <div id="startupExploreResults" class="search-results"></div>
            <div id="entitySearchResults" class="search-results"></div>
            <div id="contentSearchResults" class="search-results"></div>
            <div id="entityRelatedResults" class="search-results"></div>
            <div id="entityMentionsResults" class="search-results"></div>
            <div id="timelineResults" class="search-results" hidden></div>
            <div id="mapResults" class="search-results" hidden></div>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script>
    const form = document.getElementById("queryForm");
    const runBtn = document.getElementById("runBtn");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const summaryEl = document.getElementById("summary");
    const relatedEl = document.getElementById("related");
    const progressWrap = document.getElementById("progressWrap");
    const progressBar = document.getElementById("progressBar");
    const entitySearchEl = document.getElementById("entitySearch");
    const entitySearchBtn = document.getElementById("entitySearchBtn");
    const entitySearchResultsEl = document.getElementById("entitySearchResults");
    const contentSearchResultsEl = document.getElementById("contentSearchResults");
    const entityRelatedResultsEl = document.getElementById("entityRelatedResults");
    const entityMentionsResultsEl = document.getElementById("entityMentionsResults");
    const startupExploreResultsEl = document.getElementById("startupExploreResults");
    const timelineResultsEl = document.getElementById("timelineResults");
    const mapResultsEl = document.getElementById("mapResults");
    const runtimePanelEl = document.getElementById("runtimePanel");
    const entitySuggestionsEl = document.getElementById("entitySuggestions");
    const tabSearchEl = document.getElementById("tabSearch");
    const tabTimelineEl = document.getElementById("tabTimeline");
    const tabMapEl = document.getElementById("tabMap");

    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const topicEl = document.getElementById("topic");
    fromDate.value = fromDate.value || "2026-01-01";
    toDate.value = toDate.value || new Date().toISOString().slice(0, 10);

    let lastMeetingResults = [];
    let lastIngestSummary = null;
    let activeSidebarView = "search";
    let suggestTimer = null;

    function setSidebarView(view) {
      activeSidebarView = view;
      const allTabs = [
        [tabSearchEl, "search"],
        [tabTimelineEl, "timeline"],
        [tabMapEl, "map"],
      ];
      for (const [el, key] of allTabs) el.classList.toggle("active", key === view);

      const searchVisible = view === "search";
      entitySearchResultsEl.hidden = !searchVisible;
      contentSearchResultsEl.hidden = !searchVisible;
      entityRelatedResultsEl.hidden = !searchVisible;
      entityMentionsResultsEl.hidden = !searchVisible;
      startupExploreResultsEl.hidden = !searchVisible;
      timelineResultsEl.hidden = view !== "timeline";
      mapResultsEl.hidden = view !== "map";
    }

    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.style.color = isError ? "#b91c1c" : "#5e645f";
    }

    function setProgress(processed, discovered) {
      if (!discovered) {
        progressBar.style.width = "0%";
        return;
      }
      const pct = Math.max(0, Math.min(100, Math.round((processed / discovered) * 100)));
      progressBar.style.width = `${pct}%`;
    }

    function renderSignals(signals) {
      if (!signals) return "";
      const pairs = Object.entries(signals).filter(([, v]) => v);
      if (!pairs.length) return "";
      return `<div class="signals">${pairs.map(([k, v]) => `${k}: ${v}`).join(" | ")}</div>`;
    }

    function topicChip(topic, activeTopic) {
      const active = topic === activeTopic ? "active" : "";
      return `<button type="button" class="chip ${active}" data-topic="${topic}">${topic}</button>`;
    }

    function renderItem(item, activeTopic) {
      const topics = item.topics || [];
      const docs = item.documents || [];
      return `
        <div class="item">
          <strong>${item.item_key}</strong> ${item.title}
          <div class="topic-row">${topics.map((t) => topicChip(t, activeTopic)).join("") || ""}</div>
          ${docs.length ? `<div class="doc-list">${docs.map((d) => `<a class="doc-link" href="${d.url}" target="_blank" rel="noreferrer">${d.title || `document ${d.document_id}`}</a>`).join("")}</div>` : ""}
          ${renderSignals(item.zoning_signals)}
        </div>
      `;
    }

    function renderMinutes(metadataRows) {
      if (!metadataRows || !metadataRows.length) return "";
      return `
        <div class="minutes">
          <div class="minutes-title">Extracted Minutes Metadata</div>
          ${metadataRows
            .map((m) => {
              const bits = [];
              if (m.detected_date) bits.push(`date: ${m.detected_date}`);
              if (Number.isInteger(m.page_count)) bits.push(`pages: ${m.page_count}`);
              if (m.status) bits.push(`status: ${m.status}`);
              return `<div class="minutes-row"><a href="${m.url}" target="_blank" rel="noreferrer">${m.title || `document ${m.document_id}`}</a>${bits.length ? ` (${bits.join(" | ")})` : ""}</div>`;
            })
            .join("")}
        </div>
      `;
    }

    function renderEntitySummaryInline(entities) {
      if (!entities || !entities.length) return "";
      const top = entities.slice(0, 12);
      return `
        <div class="entity-panel">
          <div class="entity-title">Entities in this meeting</div>
          <div class="entity-list">
            ${top.map((e) => `<button type="button" class="entity-chip" data-entity-query="${e.display_value}">${e.display_value} (${e.entity_type})</button>`).join("")}
          </div>
        </div>
      `;
    }

    function renderMeetingDocumentSummary(items) {
      const docs = [];
      const seen = new Set();
      for (const item of items || []) {
        for (const d of (item.documents || [])) {
          const key = `${d.document_id}:${d.url}`;
          if (seen.has(key)) continue;
          seen.add(key);
          docs.push(d);
        }
      }
      if (!docs.length) return "";
      const top = docs.slice(0, 8);
      return `
        <div class="minutes">
          <div class="minutes-title">Documents Retrieved (${docs.length})</div>
          ${top.map((d) => `<div class="minutes-row"><a href="${d.url}" target="_blank" rel="noreferrer">${d.title || `document ${d.document_id}`}</a></div>`).join("")}
        </div>
      `;
    }

    function renderMeeting(meetingId, items, minutesMetadata, entities, activeTopic) {
      return `
        <article class="meeting">
          <h3>Meeting ${meetingId}</h3>
          <div class="meta">${items.length} matching agenda item(s)</div>
          ${renderEntitySummaryInline(entities)}
          ${renderMeetingDocumentSummary(items)}
          ${renderMinutes(minutesMetadata)}
          ${items.map((item) => renderItem(item, activeTopic)).join("") || "<div class=\"meta\">No matching agenda items.</div>"}
        </article>
      `;
    }

    function renderRelatedTopics(meetingResults, activeTopic) {
      if (!activeTopic) {
        relatedEl.hidden = true;
        return;
      }

      const counts = new Map();
      for (const r of meetingResults) {
        for (const item of r.agendaItems) {
          for (const t of item.topics || []) {
            if (t === activeTopic) continue;
            counts.set(t, (counts.get(t) || 0) + 1);
          }
        }
      }

      const ranked = [...counts.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10);
      if (!ranked.length) {
        relatedEl.hidden = false;
        relatedEl.textContent = `No related topics found for ${activeTopic}.`;
        return;
      }

      relatedEl.hidden = false;
      relatedEl.innerHTML = `Related to <strong>${activeTopic}</strong>: ${ranked
        .map(([topic, count]) => `<button type="button" class="chip" data-topic="${topic}">${topic} (${count})</button>`)
        .join(" ")}`;
    }

    async function startIngestJob(params) {
      const response = await fetch(`/ingest/range/job?${params.toString()}`, { method: "POST" });
      if (!response.ok) throw new Error(`Unable to start ingest job (${response.status})`);
      return response.json();
    }

    async function pollJob(jobId) {
      while (true) {
        const response = await fetch(`/ingest/range/job/${jobId}`);
        if (!response.ok) throw new Error(`Unable to fetch job status (${response.status})`);
        const job = await response.json();
        const progress = job.progress || {};
        const discovered = Number(progress.discovered || 0);
        const processed = Number(progress.processed || 0);
        setProgress(processed, discovered);

        const currentMeeting = progress.current_meeting_id ? ` (meeting ${progress.current_meeting_id})` : "";
        if (job.status === "running" || job.status === "queued") {
          setStatus(`Ingest progress: ${processed}/${discovered || "?"}${currentMeeting}`);
          await new Promise((resolve) => setTimeout(resolve, 900));
          continue;
        }

        if (job.status === "failed") {
          throw new Error(job.error || "Ingest job failed.");
        }

        return job.result;
      }
    }

    async function loadAgendaForMeetings(meetingIds, topic) {
      const out = [];
      let total = 0;

      for (let i = 0; i < meetingIds.length; i += 1) {
        const meetingId = meetingIds[i];
        setStatus(`Loading agenda ${i + 1}/${meetingIds.length} (meeting ${meetingId})...`);

        const agendaParams = new URLSearchParams();
        if (topic) agendaParams.set("topic", topic);

        const agendaRes = await fetch(`/meetings/${meetingId}/agenda?${agendaParams.toString()}`);
        if (!agendaRes.ok) continue;

        const agendaItems = await agendaRes.json();
        if (agendaItems.length || !topic) {
          let minutesMetadata = [];
          const minutesRes = await fetch(`/meetings/${meetingId}/minutes-metadata`);
          if (minutesRes.ok) {
            minutesMetadata = await minutesRes.json();
          }

          let entities = [];
          const entitiesRes = await fetch(`/meetings/${meetingId}/entities?limit=50`);
          if (entitiesRes.ok) {
            entities = await entitiesRes.json();
          }

          out.push({ meetingId, agendaItems, minutesMetadata, entities });
          total += agendaItems.length;
        }
      }

      return { meetingResults: out, totalItems: total };
    }

    function renderResults(meetingResults, activeTopic) {
      if (!meetingResults.length) {
        resultsEl.innerHTML = `<article class="meeting"><div class="meta">No meetings had matching agenda items for this topic.</div></article>`;
      } else {
        resultsEl.innerHTML = meetingResults
          .map((r) => renderMeeting(r.meetingId, r.agendaItems, r.minutesMetadata || [], r.entities || [], activeTopic))
          .join("");
      }
      renderRelatedTopics(meetingResults, activeTopic);
    }

    function renderEntitySearchResults(rows) {
      if (!rows.length) {
        entitySearchResultsEl.innerHTML = `<div class="search-result">No matching entities found.</div>`;
        return;
      }

      const q = (entitySearchEl.value || "").trim();
      const qRe = q ? new RegExp(`(${q.replace(/[.*+?^${}()|[\\]\\\\]/g, "\\\\$&")})`, "ig") : null;
      const highlight = (s) => {
        if (!s) return "";
        if (!qRe) return s;
        return s.replace(qRe, `<span class="context-hit">$1</span>`);
      };
      const sourceLabel = (m) => {
        if (m.source_type === "agenda_item_title") return `agenda item ${m.agenda_item_id ?? "?"}`;
        if (m.source_type === "minutes_excerpt") return `minutes doc ${m.document_id ?? "?"}`;
        if (m.source_type === "meeting_metadata") return "meeting metadata";
        return m.source_type;
      };

      entitySearchResultsEl.innerHTML = rows.map((row) => {
        const mentionRows = (row.mentions || []).map((m) => {
          const ctx = highlight(m.context_text || m.mention_text || "");
          return `
            <div class="mention-line">
              <div class="mention-meta">
                <span>meeting ${m.meeting_id}</span>
                <span>${sourceLabel(m)}</span>
                <span>confidence: ${Number(m.confidence || 0).toFixed(2)}</span>
              </div>
              <div class="mention-context">${ctx || "(no context)"}</div>
            </div>
          `;
        }).join("");
        return `<div class="search-result"><button type="button" data-entity-id="${row.entity_id}">${row.display_value}</button> <span class="meta">(${row.entity_type}) • <a class="meta-link" href="#" data-entity-mentions-id="${row.entity_id}">mentions: ${row.mention_count}</a></span><div class="mention-list">${mentionRows || "<div class='meta'>No mention preview</div>"}</div></div>`;
      }).join("");
    }

    function renderEntityRelatedResults(rows, entityLabel) {
      if (!rows.length) {
        entityRelatedResultsEl.innerHTML = `<div class="search-result">No related entities found for ${entityLabel}.</div>`;
        return;
      }
      entityRelatedResultsEl.innerHTML = `<div class="entity-title">Related to ${entityLabel}</div>` + rows.map((row) => (
        `<div class="search-result"><button type="button" data-entity-id="${row.entity_id}">${row.display_value}</button> <span class="meta">(${row.entity_type}) • shared meetings: ${row.shared_meeting_count} • co-occurrences: ${row.cooccurrence_count} • <a class="meta-link" href="#" data-entity-mentions-id="${row.entity_id}">view mentions</a></span></div>`
      )).join("");
    }

    function renderEntityMentionsDetail(entity) {
      const rows = entity?.mentions || [];
      if (!entity || !rows.length) {
        entityMentionsResultsEl.innerHTML = `<div class="search-result">No entity mentions available.</div>`;
        return;
      }
      entityMentionsResultsEl.innerHTML =
        `<div class="entity-title">Mentions for ${entity.display_value}</div>` +
        rows.map((m) => (
          `<div class="search-result"><div class="mention-meta"><span>meeting ${m.meeting_id}</span><span>${m.source_type}</span><span>confidence: ${Number(m.confidence || 0).toFixed(2)}</span></div><div class="mention-context">${m.context_text || m.mention_text}</div></div>`
        )).join("");
    }

    function renderStartupExplore(payload) {
      const entities = payload?.entities || [];
      const topics = payload?.topics || [];
      if (!entities.length && !topics.length) {
        startupExploreResultsEl.innerHTML = `<div class="search-result">No saved entities/topics yet. Run ingest to populate the explorer.</div>`;
        return;
      }
      startupExploreResultsEl.innerHTML = `
        <div class="startup-panel">
          <div class="entity-title">Popular Topics</div>
          <div class="entity-list">
            ${topics.map((t) => `<button type="button" class="entity-chip" data-topic="${t.topic}">${t.topic} (${t.count})</button>`).join("")}
          </div>
          <div class="entity-title" style="margin-top:10px;">Popular Entities</div>
          <div class="entity-list">
            ${entities.map((e) => `<button type="button" class="entity-chip" data-entity-id="${e.entity_id}" data-entity-seed="${e.display_value}">${e.display_value}</button>`).join("")}
          </div>
        </div>
      `;
    }

    function renderTimelineResults(rows) {
      if (!rows.length) {
        timelineResultsEl.innerHTML = `<div class="search-result">No timeline events found.</div>`;
        return;
      }
      timelineResultsEl.innerHTML = `<div class="search-subtitle">Timeline (date entities)</div>` + rows.map((row) => (
        `<div class="search-result"><div><strong>${row.label}</strong></div><div class="meta">normalized date: ${row.date} • meetings: ${row.meeting_ids.join(", ")} • mentions: ${row.entity_count}</div></div>`
      )).join("");
    }

    function renderMapResults(rows) {
      if (!rows.length) {
        mapResultsEl.innerHTML = `<div class="search-result">No address entities found.</div>`;
        return;
      }
      mapResultsEl.innerHTML = `<div class="search-subtitle">Map View (address entities; external map links)</div>` + rows.map((row) => (
        `<div class="search-result"><button type="button" data-entity-id="${row.entity_id}">${row.address}</button> <span class="meta">(address)</span><div class="meta">city: ${row.city_hint} • state: ${row.state_hint} • shared meetings: ${row.shared_meeting_count} • mentions: ${row.mention_count}</div><a class="map-link" target="_blank" rel="noreferrer" href="https://www.openstreetmap.org/search?query=${encodeURIComponent(row.map_query)}">Open in OpenStreetMap</a></div>`
      )).join("");
    }

    async function loadTimelineView() {
      timelineResultsEl.innerHTML = `<div class="search-result">Loading timeline...</div>`;
      const q = (entitySearchEl.value || "").trim();
      const url = q ? `/explore/timeline?q=${encodeURIComponent(q)}` : "/explore/timeline";
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Timeline load failed (${res.status})`);
      renderTimelineResults(await res.json());
    }

    async function loadMapView() {
      mapResultsEl.innerHTML = `<div class="search-result">Loading addresses...</div>`;
      const q = (entitySearchEl.value || "").trim();
      const url = q ? `/explore/locations?q=${encodeURIComponent(q)}` : "/explore/locations";
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Map data load failed (${res.status})`);
      renderMapResults(await res.json());
    }

    function renderSuggestions(rows) {
      if (!rows.length) {
        entitySuggestionsEl.hidden = true;
        entitySuggestionsEl.innerHTML = "";
        return;
      }
      entitySuggestionsEl.innerHTML = rows.map((row) => (
        `<button type="button" class="suggestion-item" data-entity-id="${row.entity_id}" data-suggest-text="${row.display_value}">${row.display_value}<div class="suggestion-meta">${row.entity_type} • score ${Number(row.score).toFixed(2)}</div></button>`
      )).join("");
      entitySuggestionsEl.hidden = false;
    }

    async function loadSuggestions() {
      const q = (entitySearchEl.value || "").trim();
      if (q.length < 2) {
        renderSuggestions([]);
        return;
      }
      try {
        const res = await fetch(`/entities/suggest?q=${encodeURIComponent(q)}&limit=8`);
        if (!res.ok) return;
        const rows = await res.json();
        renderSuggestions(rows);
      } catch {
        renderSuggestions([]);
      }
    }

    function renderContentSearchResults(payload, q) {
      const agenda = payload?.agenda_topics || [];
      const docs = payload?.documents || [];
      const esc = (s) => (s || "").replace(/[&<>]/g, (ch) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[ch]));
      const qRe = q ? new RegExp(`(${q.replace(/[.*+?^${}()|[\\]\\\\]/g, "\\\\$&")})`, "ig") : null;
      const hl = (s) => {
        const safe = esc(s || "");
        if (!qRe) return safe;
        return safe.replace(qRe, `<span class="context-hit">$1</span>`);
      };

      let html = "";
      html += `<div class="search-subtitle">Matching Agenda Topics</div>`;
      html += agenda.length
        ? agenda.map((a) => `<div class="search-result"><div><strong>Meeting ${a.meeting_id} • ${a.item_key}</strong></div><div class="meta">${a.section || "agenda"}</div><div class="mention-context">${hl(a.title)}</div></div>`).join("")
        : `<div class="search-result">No agenda topic matches.</div>`;

      html += `<div class="search-subtitle">Matching Documents</div>`;
      html += docs.length
        ? docs.map((d) => `<div class="search-result"><div><strong>Meeting ${d.meeting_id}</strong> <span class="meta">doc ${d.document_id}</span></div><div class="mention-context"><a href="${d.url}" target="_blank" rel="noreferrer">${hl(d.title)}</a></div></div>`).join("")
        : `<div class="search-result">No document matches.</div>`;

      contentSearchResultsEl.innerHTML = html;
    }

    async function loadRuntimeDiagnostics() {
      try {
        const res = await fetch("/runtime");
        if (!res.ok) throw new Error(`runtime check failed (${res.status})`);
        const info = await res.json();
        const ok = Boolean(info.pypdf_available);
        runtimePanelEl.innerHTML = `
          <div><strong>Runtime Diagnostics</strong></div>
          <div class="${ok ? "runtime-ok" : "runtime-warn"}">pypdf: ${ok ? "available" : "unavailable"}</div>
          <div class="meta">${info.python_executable || ""}</div>
        `;
      } catch (err) {
        runtimePanelEl.textContent = err.message || "Runtime diagnostics unavailable.";
      }
    }

    async function loadStartupExplore() {
      try {
        const res = await fetch("/explore/popular");
        if (!res.ok) throw new Error(`Explore load failed (${res.status})`);
        renderStartupExplore(await res.json());
      } catch (err) {
        startupExploreResultsEl.innerHTML = `<div class="search-result">${err.message || "Unable to load explorer seed data."}</div>`;
      }
    }

    async function loadRelatedEntities(entityId, entityLabel) {
      try {
        const res = await fetch(`/entities/${entityId}/related?limit=15`);
        if (!res.ok) throw new Error(`Related lookup failed (${res.status})`);
        const rows = await res.json();
        renderEntityRelatedResults(rows, entityLabel);
      } catch (err) {
        entityRelatedResultsEl.innerHTML = `<div class="search-result">${err.message || "Related lookup failed."}</div>`;
      }
    }

    async function loadEntityMentions(entityId) {
      try {
        const res = await fetch(`/entities/${entityId}?mention_limit=200`);
        if (!res.ok) throw new Error(`Entity detail failed (${res.status})`);
        const entity = await res.json();
        renderEntityMentionsDetail(entity);
      } catch (err) {
        entityMentionsResultsEl.innerHTML = `<div class="search-result">${err.message || "Unable to load mentions."}</div>`;
      }
    }

    function syncWorkspaceHeight() {
      const workspace = document.querySelector(".workspace");
      if (!(workspace instanceof HTMLElement)) return;
      if (window.innerWidth <= 900) {
        workspace.style.height = "auto";
        return;
      }
      const top = workspace.getBoundingClientRect().top;
      const height = Math.max(360, Math.floor(window.innerHeight - top - 12));
      workspace.style.height = `${height}px`;
    }

    async function searchEntities() {
      const q = (entitySearchEl.value || "").trim();
      setSidebarView("search");
      if (!q) {
        entitySearchResultsEl.innerHTML = "";
        contentSearchResultsEl.innerHTML = "";
        entityRelatedResultsEl.innerHTML = "";
        entityMentionsResultsEl.innerHTML = "";
        renderSuggestions([]);
        return;
      }
      renderSuggestions([]);
      entitySearchBtn.disabled = true;
      try {
        const [entityRes, contentRes] = await Promise.all([
          fetch(`/entities/search?q=${encodeURIComponent(q)}`),
          fetch(`/search/content?q=${encodeURIComponent(q)}`),
        ]);
        if (!entityRes.ok) throw new Error(`Entity search failed (${entityRes.status})`);
        if (!contentRes.ok) throw new Error(`Content search failed (${contentRes.status})`);
        const rows = await entityRes.json();
        const content = await contentRes.json();
        renderEntitySearchResults(rows);
        renderContentSearchResults(content, q);
      } catch (err) {
        entitySearchResultsEl.innerHTML = `<div class="search-result">${err.message || "Search failed."}</div>`;
        contentSearchResultsEl.innerHTML = "";
      } finally {
        entitySearchBtn.disabled = false;
      }
    }

    async function runQuery(event) {
      event.preventDefault();
      runBtn.disabled = true;
      resultsEl.innerHTML = "";
      summaryEl.hidden = true;
      relatedEl.hidden = true;
      progressWrap.hidden = false;
      setProgress(0, 0);

      const params = new URLSearchParams({
        from_date: fromDate.value,
        to_date: toDate.value,
        limit: document.getElementById("limit").value,
        crawl: String(document.getElementById("crawl").checked),
        chunk_days: document.getElementById("chunkDays").value,
        store_raw: String(document.getElementById("storeRaw").checked),
      });

      const topic = topicEl.value;

      try {
        setStatus("Starting ingest job...");
        const job = await startIngestJob(params);
        const ingest = await pollJob(job.job_id);

        const meetingIds = (ingest.results || []).map((r) => r.meeting_id).filter(Boolean);
        const loaded = await loadAgendaForMeetings(meetingIds, topic);

        document.getElementById("kDiscovered").textContent = String(ingest.discovered || 0);
        document.getElementById("kIngested").textContent = String(ingest.ingested || 0);
        document.getElementById("kItems").textContent = String(loaded.totalItems);
        summaryEl.hidden = false;

        lastMeetingResults = loaded.meetingResults;
        lastIngestSummary = ingest;

        renderResults(lastMeetingResults, topic);
        setStatus("Completed.");
      } catch (error) {
        setStatus(error.message || "Something went wrong.", true);
      } finally {
        runBtn.disabled = false;
      }
    }

    async function rerunTopicOnly(topic) {
      if (!lastIngestSummary) return;
      runBtn.disabled = true;
      try {
        const meetingIds = (lastIngestSummary.results || []).map((r) => r.meeting_id).filter(Boolean);
        const loaded = await loadAgendaForMeetings(meetingIds, topic);
        lastMeetingResults = loaded.meetingResults;
        document.getElementById("kItems").textContent = String(loaded.totalItems);
        renderResults(lastMeetingResults, topic);
        setStatus(`Filtered by topic: ${topic || "all"}.`);
      } finally {
        runBtn.disabled = false;
      }
    }

    form.addEventListener("submit", runQuery);
    entitySearchBtn.addEventListener("click", searchEntities);
    tabSearchEl.addEventListener("click", () => setSidebarView("search"));
    tabTimelineEl.addEventListener("click", async () => {
      setSidebarView("timeline");
      try { await loadTimelineView(); } catch (err) { timelineResultsEl.innerHTML = `<div class="search-result">${err.message || "Timeline load failed."}</div>`; }
    });
    tabMapEl.addEventListener("click", async () => {
      setSidebarView("map");
      try { await loadMapView(); } catch (err) { mapResultsEl.innerHTML = `<div class="search-result">${err.message || "Map load failed."}</div>`; }
    });
    loadRuntimeDiagnostics();
    loadStartupExplore();
    setSidebarView("search");
    syncWorkspaceHeight();
    window.addEventListener("resize", syncWorkspaceHeight);
    entitySearchEl.addEventListener("input", () => {
      if (suggestTimer) clearTimeout(suggestTimer);
      suggestTimer = setTimeout(loadSuggestions, 180);
    });
    entitySearchEl.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        searchEntities();
      }
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("chip")) return;

      const topic = target.dataset.topic || "";
      topicEl.value = topic;
      rerunTopicOnly(topic);
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const suggestion = target.closest(".suggestion-item");
      if (suggestion instanceof HTMLElement) {
        const text = suggestion.dataset.suggestText || suggestion.textContent || "";
        entitySearchEl.value = text.trim();
        renderSuggestions([]);
        searchEntities();
        return;
      }
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (!target.classList.contains("entity-chip")) return;
      const query = target.dataset.entityQuery || "";
      entitySearchEl.value = query;
      searchEntities();
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const button = target.closest("button[data-entity-id]");
      if (!(button instanceof HTMLElement)) return;
      const entityId = button.dataset.entityId;
      const label = button.textContent || "entity";
      if (!entityId) return;
      if (button.dataset.entitySeed || label) {
        entitySearchEl.value = (button.dataset.entitySeed || label).trim();
      }
      setSidebarView("search");
      searchEntities();
      loadRelatedEntities(entityId, label);
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const link = target.closest("[data-entity-mentions-id]");
      if (!(link instanceof HTMLElement)) return;
      event.preventDefault();
      const entityId = link.dataset.entityMentionsId;
      if (!entityId) return;
      setSidebarView("search");
      loadEntityMentions(entityId);
    });

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      if (target.closest(".search-box")) return;
      if (!entitySuggestionsEl.hidden) renderSuggestions([]);
    });
  </script>
</body>
</html>
